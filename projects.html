<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Boxicons -->
	<link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
	<!-- My CSS -->
	<link rel="stylesheet" href="style.css">
	<link href="https://cdn.jsdelivr.net/npm/tailwindcss@^3.0/dist/tailwind.min.css" rel="stylesheet">
</head>
<body>

	<!-- SIDEBAR -->
	<section id="sidebar">
		<a href="#" class="brand">
			<i class='bx bxs-smile'></i>
			<span class="text">Scrumflow</span>
		</a>
		<ul class="side-menu top">
			<li>
				<a href="index.html">
					<i class='bx bxs-dashboard' ></i>
					<span class="text">Dashboard</span>
				</a>
			</li>
			<li class="active">
				<a href="projects.html">
					<i class='bx bxs-shopping-bag-alt' ></i>
					<span class="text">Projects</span>
				</a>
			</li>
		</ul>
		<ul class="side-menu">
			<li>
				<a href="#">
					<i class='bx bxs-cog' ></i>
					<span class="text">Settings</span>
				</a>
			</li>
			<li>
				<a href="#" class="logout">
					<i class='bx bxs-log-out-circle' ></i>
					<span class="text">Logout</span>
				</a>
			</li>
		</ul>
	</section>
	<!-- SIDEBAR -->
	<!-- Fenster zum Hinzufügen von Projekten -->
	<dialog id="my_modal_1" class="modal">
		<div class="modal-box">
			<button class="close-icon" onclick="my_modal_1.close()">&times;</button>
			<h3>Add Project</h3>
			<input type="text" placeholder="Name of the project" class="input-text"/>
			<p>Due date:</p>
			<input type="date" class="input-date"/>
			<div class="select-container">
				<p>Category</p>
				<select id="category" class="select-category">
					<option selected="">Select category</option>
					<option value="School">School</option>
					<option value="Work">Work</option>
					<option value="Leisure">Leisure Time</option>
				</select>
			</div>
			<div class="modal-action">
				<button id="submitBtn" class="submit-btn">Submit</button>
			</div>
		</div>
	</dialog>
	


	<!-- CONTENT -->
	<section id="content">
		<!-- NAVBAR -->
		<nav>
			<i class='bx bx-menu' ></i>
			<input type="checkbox" id="switch-mode" hidden>
			<label for="switch-mode" class="switch-mode"></label>
			<a href="#" class="notification">
				<i class='bx bxs-bell' ></i>
				<span class="num">8</span>
			</a>
			<a href="#" class="profile">
				<img src="img/people.png">
			</a>
		</nav>
		<!-- NAVBAR -->

		<!-- MAIN -->
		<main>
			<div class="head-title">
				<div class="left">
					<h1>Projects</h1>
					<button class="plus-button" id="addBtn" onclick="my_modal_1.showModal()">+</button>
					<ul class="breadcrumb">
						<li>
							<a href="#">Projects</a>
						</li>
						<li><i class='bx bx-chevron-right' ></i></li>
						<li>
							<a class="active" href="#">Home</a>
						</li>
					</ul>
				</div>
			</div>
			
		</main>
		<div id="project-list-container"></div>
		<!-- MAIN -->
	</section>
	<!-- CONTENT -->
	<script>
		import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
		import { getFirestore, collection, getDoc, getDocs, addDoc, deleteDoc, updateDoc, doc, getCountFromServer } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
		import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

		const firebaseConfig = {
			apiKey: "AIzaSyDZJTH0Znyi13etPM6Ag5M-lQ_WeqXOIsU",
			authDomain: "scrumflow-6e479.firebaseapp.com",
			projectId: "scrumflow-6e479",
			storageBucket: "scrumflow-6e479.appspot.com",
			messagingSenderId: "828323679259",
			appId: "1:828323679259:web:6db3cfbf89942cc3d4fcbe",
			measurementId: "G-2427QNHC73"
		};

		const app = initializeApp(firebaseConfig);
		const db = getFirestore(app);
		const auth = getAuth(app);

		//let currentProject = null;

		// Authentifizierungsstatus beibehalten
		onAuthStateChanged(auth, (user) => {
			if (user) {
				console.log("User is signed in with UID:", user.uid);
				loadProjectsIntoHTML();
			} else {
				console.log("No user is signed in.");
			}
		});

		function loadProjectsIntoHTML() {
			const user = auth.currentUser;
			if (user) {
				const projectsRef = collection(db, "users", user.uid, "projects");
				getDocs(projectsRef)
						.then(querySnapshot => {
							const projects = [];
							querySnapshot.forEach(doc => {
								const projectData = doc.data();
								const project = { id: doc.id, ...projectData };
								projects.push(project);
							});

							// Container für die Projektliste
							const container = document.getElementById('project-list-container');

							// Durch jedes Projekt iterieren und eine Card erstellen
							projects.forEach(async project => {
								const card = document.createElement('div');
								card.classList.add('folder');

								const title = document.createElement('h2');
								title.classList.add('name');
								if (project.title.length > 14) {
									project.title = project.title.substring(0, 12) + '...';
								}
								title.textContent = project.title;
								card.appendChild(title);

								const options = document.createElement('div');
								options.classList.add('options');





								const tasksRef = collection(db, "users", user.uid, "projects", project.id, "tasks");

								const taskSnapshot = await getCountFromServer(tasksRef);
								let tasksAmount = taskSnapshot.data().count;

								const option1 = document.createElement('h5');
								option1.textContent = 'Tasks: ' + tasksAmount;
								options.appendChild(option1);

								const option2 = document.createElement('h5');
								const endDate = project.endDate.toDate();
								option2.textContent = endDate.toDateString();
								options.appendChild(option2);

								card.appendChild(options);

								// Weitere Informationen können hier hinzugefügt werden, z.B. Beschreibung, Datum usw.

								container.appendChild(card);
							});
						})
						.catch(error => {
							console.error("Error loading projects: ", error);
						});
			} else {
				console.log("No user signed in.");
			}
		}

		// SIDE MENU

		const allSideMenu = document.querySelectorAll('#sidebar .side-menu.top li a');

		allSideMenu.forEach(item=> {
			const li = item.parentElement;

			item.addEventListener('click', function () {
				allSideMenu.forEach(i=> {
					i.parentElement.classList.remove('active');
				})
				li.classList.add('active');
			})
		});

		// TOGGLE SIDEBAR
		const menuBar = document.querySelector('#content nav .bx.bx-menu');
		const sidebar = document.getElementById('sidebar');

		menuBar.addEventListener('click', function () {
			sidebar.classList.toggle('hide');
		})

		const searchButton = document.querySelector('#content nav form .form-input button');
		const searchButtonIcon = document.querySelector('#content nav form .form-input button .bx');
		const searchForm = document.querySelector('#content nav form');

		searchButton.addEventListener('click', function (e) {
			if(window.innerWidth < 576) {
				e.preventDefault();
				searchForm.classList.toggle('show');
				if(searchForm.classList.contains('show')) {
					searchButtonIcon.classList.replace('bx-search', 'bx-x');
				} else {
					searchButtonIcon.classList.replace('bx-x', 'bx-search');
				}
			}
		})

		if(window.innerWidth < 768) {
			sidebar.classList.add('hide');
		} else if(window.innerWidth > 576) {
			searchButtonIcon.classList.replace('bx-x', 'bx-search');
			searchForm.classList.remove('show');
		}

		window.addEventListener('resize', function () {
			if(this.innerWidth > 576) {
				searchButtonIcon.classList.replace('bx-x', 'bx-search');
				searchForm.classList.remove('show');
			}
		})

		const switchMode = document.getElementById('switch-mode');

		switchMode.addEventListener('change', function () {
			if(this.checked) {
				document.body.classList.add('dark');
			} else {
				document.body.classList.remove('dark');
			}
		})

		/*const addBtn = document.querySelector('.submit-btn'),
            titleEl = document.querySelector('.input-text'),
            dateEl=document.querySelector('.input-date'),
            category=document.querySelector('.select-category');

        const submitBtn = document.getElementById('submitBtn');
        submitBtn.addEventListener('click', (e) => {
            e.preventDefault();

            console.log("Add-Funktion")
            let projectTitle = titleEl.value;
            let projectDate = new Date(dateEl.value);
            let projectCategory = category.value;

            const newProject = {
                title: projectTitle,
                endDate: projectDate,
                category: projectCategory
            }
            addProjectToFirestore(newProject);

        });*/

		const titleEl = document.querySelector('.input-text');
		const dateEl = document.querySelector('.input-date');
		const category = document.querySelector('.select-category');

		const submitBtn = document.getElementById('submitBtn');
		submitBtn.addEventListener('click', (e) => {
			e.preventDefault();

			console.log("Add-Funktion")
			let projectTitle = titleEl.value;
			let projectDate = new Date(dateEl.value);
			let projectCategory = category.value;

			const newProject = {
				title: projectTitle,
				endDate: projectDate,
				category: projectCategory
			}
			addProjectToFirestore(newProject);

		});


		function addProjectToFirestore(newProject) {
			const user = auth.currentUser;
			if (!user) {
				alert("You must be logged in to add events.");
				return;
			}

			const projectsRef = collection(db, "users", user.uid, "projects");
			addDoc(projectsRef, newProject).then(docRef => {
				newProject.id = docRef.id;
				projectsArr.push(newProject);
				showProjects();
				closeIcon.click();
			}).catch(error => {
				console.error("Error adding event: ", error);
			});
		}
	</script>

</body>
</html>